#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Secure PKI in /data, user files in /share
# ==============================================================================

# Private data in /data
declare data_dir="/data/openvpn"
declare pki_dir="${data_dir}/pki"
declare server_conf="${data_dir}/server.conf"

# User-accessible in /share
declare share_dir="/share/openvpn"
declare clients_dir="${share_dir}/clients"

bashio::log.info "Starting OpenVPN Server..."

# Create directory structure
mkdir -p "${data_dir}"
mkdir -p "${pki_dir}"
mkdir -p "${clients_dir}"

# Check if PKI is COMPLETELY initialized - verify ALL required files
if [[ ! -f "${pki_dir}/ca.crt" ]] || \
   [[ ! -f "${pki_dir}/issued/server.crt" ]] || \
   [[ ! -f "${pki_dir}/private/server.key" ]] || \
   [[ ! -f "${pki_dir}/dh.pem" ]] || \
   [[ ! -f "${pki_dir}/ta.key" ]]; then
    
    bashio::log.warning "PKI incomplete or missing. (Re)initializing..."
    
    # Clean up any incomplete PKI to start fresh
    rm -rf "${pki_dir}"
    rm -rf "${data_dir}/easy-rsa"
    
    # Run full initialization
    bashio::log.info "Running complete PKI initialization..."
    /usr/bin/openvpn-init || bashio::exit.nok "Failed to initialize PKI"
    
    # Verify initialization succeeded
    if [[ ! -f "${pki_dir}/ta.key" ]]; then
        bashio::exit.nok "PKI initialization failed - ta.key not created"
    fi
    
    bashio::log.info "âœ“ PKI initialization successful"
fi

# Get configuration
PROTO=$(bashio::config 'proto')
PORT=$(bashio::config 'port')
SERVER_SUBNET=$(bashio::config 'server_subnet')
SERVER_NETMASK=$(bashio::config 'server_netmask')
CIPHER=$(bashio::config 'cipher')
AUTH=$(bashio::config 'auth')
CLIENT_TO_CLIENT=$(bashio::config 'client_to_client')
DUPLICATE_CN=$(bashio::config 'duplicate_cn')
MAX_CLIENTS=$(bashio::config 'max_clients')
LOG_LEVEL=$(bashio::config 'log_level')

bashio::log.info "Generating server configuration..."

# Create server.conf
cat > "${server_conf}" <<EOF
# OpenVPN Server Configuration
# Generated by Home Assistant Add-on
port ${PORT}
proto ${PROTO}
dev tun0
topology subnet

# Certificates and keys (secure in /data)
ca ${pki_dir}/ca.crt
cert ${pki_dir}/issued/server.crt
key ${pki_dir}/private/server.key
dh ${pki_dir}/dh.pem
tls-auth ${pki_dir}/ta.key 0

# Network configuration
server ${SERVER_SUBNET} ${SERVER_NETMASK}
ifconfig-pool-persist ${data_dir}/ipp.txt

# Push routes to clients
EOF

# Add DNS servers
for dns in $(bashio::config 'dns_servers'); do
    echo "push \"dhcp-option DNS ${dns}\"" >> "${server_conf}"
done

# Add routes - iterate through array properly  
declare route_count
route_count=$(bashio::config 'routes | length')

if [[ "${route_count}" -gt 0 ]]; then
    for (( i=0; i < route_count; i++ )); do
        route=$(bashio::config "routes[${i}]")
        echo "push \"route ${route}\"" >> "${server_conf}"
    done
fi

# Client options
if bashio::config.true 'client_to_client'; then
    echo "client-to-client" >> "${server_conf}"
fi

if bashio::config.true 'duplicate_cn'; then
    echo "duplicate-cn" >> "${server_conf}"
fi

# Continue server.conf
cat >> "${server_conf}" <<EOF

# Connection settings
max-clients ${MAX_CLIENTS}
keepalive 10 120
persist-key
persist-tun

# Security
cipher ${CIPHER}
auth ${AUTH}
tls-version-min 1.2

# Logging
status ${data_dir}/openvpn-status.log
verb ${LOG_LEVEL}

# Client config directory
client-config-dir ${data_dir}/ccd

# Explicit exit notify for UDP
explicit-exit-notify 1
EOF

# Create client config directory
mkdir -p "${data_dir}/ccd"

# Create user README in /share
cat > "${share_dir}/README.txt" <<'READMEEOF'
OpenVPN Server - Download Your Clients Here
============================================

Client configuration files (.ovpn) are in the "clients" folder.

Download via:
- File Editor: Browse to /share/openvpn/clients/
- Samba: \\homeassistant\share\openvpn\clients\
- SSH: /share/openvpn/clients/

Before using a client file:
1. Open the .ovpn file in a text editor
2. Find the line: remote YOUR_PUBLIC_IP_OR_DDNS 1194
3. Replace YOUR_PUBLIC_IP_OR_DDNS with your actual:
   - Public IP address (find at whatismyip.com), OR
   - DuckDNS hostname (e.g., yourhome.duckdns.org)
4. Save the file
5. Import to OpenVPN Connect app on your device

To create new clients:
1. Open OpenVPN Server add-on
2. Click "Terminal" tab (appears once add-on is running)
3. Run: openvpn-client-add clientname
4. Download the .ovpn file from clients folder

Commands available in Terminal:
- openvpn-client-add <name>     Create new client
- openvpn-client-list            List all clients
- openvpn-client-revoke <name>   Revoke a client

Port forwarding required:
Forward UDP port 1194 on your router to your Home Assistant IP.
READMEEOF

# Enable IP forwarding
bashio::log.info "Enabling IP forwarding..."
sysctl -w net.ipv4.ip_forward=1 >/dev/null 2>&1 || \
    bashio::log.warning "Could not enable IP forwarding (may already be enabled by system)"

# Setup iptables rules
bashio::log.info "Configuring firewall rules..."
iptables -t nat -A POSTROUTING -s ${SERVER_SUBNET}/24 -o eth0 -j MASQUERADE 2>&1 || true
iptables -A FORWARD -i tun0 -j ACCEPT 2>&1 || true
iptables -A FORWARD -o tun0 -j ACCEPT 2>&1 || true

bashio::log.info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
bashio::log.info "âœ“ PKI secure in: /data/openvpn/pki/"
bashio::log.info "âœ“ Download clients from: /share/openvpn/clients/"
bashio::log.info "âœ“ Server config: ${PROTO}/${PORT}"
bashio::log.info "âœ“ VPN subnet: ${SERVER_SUBNET}/${SERVER_NETMASK}"
bashio::log.info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
bashio::log.info "Starting OpenVPN daemon..."

# ============================================================================
# CLIENT MANAGEMENT
# ============================================================================
CLIENT_NAME=$(bashio::config 'client_name')
CLIENT_ACTION=$(bashio::config 'client_action')

if [[ "${CLIENT_ACTION}" != "none" ]]; then
    bashio::log.info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    bashio::log.info "ðŸ“± Client Management Action: ${CLIENT_ACTION}"
    
    case "${CLIENT_ACTION}" in
        create)
            if [[ -z "${CLIENT_NAME}" ]]; then
                bashio::log.error "âŒ Client name is required for create action"
            elif [[ -f "${pki_dir}/issued/${CLIENT_NAME}.crt" ]]; then
                bashio::log.warning "âš ï¸  Client '${CLIENT_NAME}' already exists"
                bashio::log.warning "ðŸ“ Download: /share/openvpn/clients/${CLIENT_NAME}.ovpn"
                bashio::log.warning ""
                bashio::log.warning "ðŸ’¡ Use 'recreate' action to regenerate .ovpn file"
                bashio::log.warning "   or choose different name"
            else
                bashio::log.info "Creating new client: ${CLIENT_NAME}"
                /usr/bin/openvpn-client-add "${CLIENT_NAME}"
                
                bashio::log.notice "âœ… Client '${CLIENT_NAME}' created successfully!"
                bashio::log.notice "ðŸ“ Download: /share/openvpn/clients/${CLIENT_NAME}.ovpn"
            fi
            ;;
            
        recreate)
            if [[ -z "${CLIENT_NAME}" ]]; then
                bashio::log.error "âŒ Client name is required for recreate action"
            elif [[ ! -f "${pki_dir}/issued/${CLIENT_NAME}.crt" ]]; then
                bashio::log.error "âŒ Client '${CLIENT_NAME}' doesn't exist"
                bashio::log.error "ðŸ’¡ Use 'create' action instead"
            else
                bashio::log.info "Regenerating .ovpn file for: ${CLIENT_NAME}"
                
                # Delete old .ovpn file
                rm -f "${clients_dir}/${CLIENT_NAME}.ovpn"
                
                # Regenerate using openvpn-client-add (will skip cert generation)
                /usr/bin/openvpn-client-add "${CLIENT_NAME}" 2>/dev/null || {
                    # If fails, manually regenerate .ovpn
                    bashio::log.info "Manually regenerating .ovpn file..."
                    
                    PROTO=$(bashio::config 'proto')
                    PORT=$(bashio::config 'port')
                    CIPHER=$(bashio::config 'cipher')
                    AUTH=$(bashio::config 'auth')
                    
                    cat > "${clients_dir}/${CLIENT_NAME}.ovpn" <<EOF
# OpenVPN Client: ${CLIENT_NAME}
# Regenerated: $(date)

client
dev tun
proto ${PROTO}
remote YOUR_PUBLIC_IP_OR_DDNS ${PORT}
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher ${CIPHER}
auth ${AUTH}
verb 3
key-direction 1

<ca>
$(cat "${pki_dir}/ca.crt")
</ca>

<cert>
$(openssl x509 -in "${pki_dir}/issued/${CLIENT_NAME}.crt")
</cert>

<key>
$(cat "${pki_dir}/private/${CLIENT_NAME}.key")
</key>

<tls-auth>
$(cat "${pki_dir}/ta.key")
</tls-auth>
EOF
                    chmod 600 "${clients_dir}/${CLIENT_NAME}.ovpn"
                }
                
                bashio::log.notice "âœ… File regenerated: /share/openvpn/clients/${CLIENT_NAME}.ovpn"
            fi
            ;;
            
        revoke)
            if [[ -z "${CLIENT_NAME}" ]]; then
                bashio::log.error "âŒ Client name is required for revoke action"
            elif [[ ! -f "${pki_dir}/issued/${CLIENT_NAME}.crt" ]]; then
                bashio::log.error "âŒ Client '${CLIENT_NAME}' doesn't exist"
            else
                bashio::log.warning "ðŸ”’ Revoking client: ${CLIENT_NAME}"
                /usr/bin/openvpn-client-revoke "${CLIENT_NAME}"
                
                bashio::log.notice "âœ… Client '${CLIENT_NAME}' revoked"
                bashio::log.notice "âš ï¸  Restart add-on for revocation to take effect"
            fi
            ;;
            
        list)
            bashio::log.info "ðŸ“‹ Listing all VPN clients..."
            /usr/bin/openvpn-client-list
            ;;
            
        *)
            bashio::log.error "âŒ Unknown action: ${CLIENT_ACTION}"
            ;;
    esac
    
    bashio::log.info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    bashio::log.notice ""
    bashio::log.notice "âš ï¸  IMPORTANT: Set 'Client Action' back to 'none' and Save"
    bashio::log.notice "   to prevent action from repeating on restart"
    bashio::log.notice ""
    bashio::log.info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
fi

# Start OpenVPN - redirect stderr to stdout to capture errors
openvpn --config "${server_conf}" 2>&1
