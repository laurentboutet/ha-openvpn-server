#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Runs the OpenVPN server
# ==============================================================================
declare config_dir="/data/openvpn"
declare pki_dir="${config_dir}/pki"
declare server_conf="${config_dir}/server.conf"

bashio::log.info "Starting OpenVPN Server..."

# Check if PKI is initialized
if [[ ! -f "${pki_dir}/ca.crt" ]]; then
    bashio::log.info "PKI not initialized. Running initialization..."
    /usr/bin/openvpn-init || bashio::exit.nok "Failed to initialize PKI"
fi

# Get configuration
PROTO=$(bashio::config 'proto')
PORT=$(bashio::config 'port')
SERVER_SUBNET=$(bashio::config 'server_subnet')
SERVER_NETMASK=$(bashio::config 'server_netmask')
CIPHER=$(bashio::config 'cipher')
AUTH=$(bashio::config 'auth')
CLIENT_TO_CLIENT=$(bashio::config 'client_to_client')
DUPLICATE_CN=$(bashio::config 'duplicate_cn')
MAX_CLIENTS=$(bashio::config 'max_clients')
LOG_LEVEL=$(bashio::config 'log_level')

bashio::log.info "Generating server configuration..."

# Create server.conf
cat > "${server_conf}" <<EOF
# OpenVPN Server Configuration
port ${PORT}
proto ${PROTO}
dev tun0
topology subnet

# Certificates and keys
ca ${pki_dir}/ca.crt
cert ${pki_dir}/issued/server.crt
key ${pki_dir}/private/server.key
dh ${pki_dir}/dh.pem
tls-auth ${pki_dir}/ta.key 0

# Network configuration
server ${SERVER_SUBNET} ${SERVER_NETMASK}
ifconfig-pool-persist ${config_dir}/ipp.txt

# Push routes to clients
EOF

# Add DNS servers
for dns in $(bashio::config 'dns_servers'); do
    echo "push \"dhcp-option DNS ${dns}\"" >> "${server_conf}"
done

# Add routes
for route in $(bashio::config 'routes'); do
    echo "push \"route ${route}\"" >> "${server_conf}"
done

# Client options
if bashio::config.true 'client_to_client'; then
    echo "client-to-client" >> "${server_conf}"
fi

if bashio::config.true 'duplicate_cn'; then
    echo "duplicate-cn" >> "${server_conf}"
fi

# Continue server.conf
cat >> "${server_conf}" <<EOF

# Connection settings
max-clients ${MAX_CLIENTS}
keepalive 10 120
persist-key
persist-tun

# Security
cipher ${CIPHER}
auth ${AUTH}
tls-version-min 1.2

# Logging - output to stdout so we can see errors
status ${config_dir}/openvpn-status.log
verb ${LOG_LEVEL}

# Client config directory
client-config-dir ${config_dir}/ccd

# Explicit exit notify for UDP
explicit-exit-notify 1
EOF

# Create client config directory
mkdir -p "${config_dir}/ccd"

# Enable IP forwarding - Use sysctl instead of direct write
bashio::log.info "Enabling IP forwarding..."
sysctl -w net.ipv4.ip_forward=1 >/dev/null 2>&1 || \
    bashio::log.warning "Could not enable IP forwarding (may already be enabled)"

# Setup iptables rules
bashio::log.info "Configuring firewall rules..."
iptables -t nat -A POSTROUTING -s ${SERVER_SUBNET}/24 -o eth0 -j MASQUERADE 2>&1 || true
iptables -A FORWARD -i tun0 -j ACCEPT 2>&1 || true
iptables -A FORWARD -o tun0 -j ACCEPT 2>&1 || true

bashio::log.info "OpenVPN configuration complete. Starting OpenVPN..."

# Start OpenVPN - removed exec to capture output, redirect errors to stdout
openvpn --config "${server_conf}" 2>&1
