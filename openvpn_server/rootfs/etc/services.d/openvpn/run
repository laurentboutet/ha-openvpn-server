#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Secure PKI in /data, user files in /share
# ==============================================================================

# Private data in /data
declare data_dir="/data/openvpn"
declare pki_dir="${data_dir}/pki"
declare server_conf="${data_dir}/server.conf"

# User-accessible in /share
declare share_dir="/share/openvpn"
declare clients_dir="${share_dir}/clients"

bashio::log.info "Starting OpenVPN Server..."

# Create directory structure
mkdir -p "${data_dir}"
mkdir -p "${pki_dir}"
mkdir -p "${clients_dir}"

# Check if PKI is initialized
if [[ ! -f "${pki_dir}/ca.crt" ]]; then
    bashio::log.info "PKI not initialized. Running initialization..."
    /usr/bin/openvpn-init || bashio::exit.nok "Failed to initialize PKI"
fi

# Get configuration
PROTO=$(bashio::config 'proto')
PORT=$(bashio::config 'port')
SERVER_SUBNET=$(bashio::config 'server_subnet')
SERVER_NETMASK=$(bashio::config 'server_netmask')
CIPHER=$(bashio::config 'cipher')
AUTH=$(bashio::config 'auth')
CLIENT_TO_CLIENT=$(bashio::config 'client_to_client')
DUPLICATE_CN=$(bashio::config 'duplicate_cn')
MAX_CLIENTS=$(bashio::config 'max_clients')
LOG_LEVEL=$(bashio::config 'log_level')

bashio::log.info "Generating server configuration..."

# Create server.conf
cat > "${server_conf}" <<EOF
# OpenVPN Server Configuration
port ${PORT}
proto ${PROTO}
dev tun0
topology subnet

# Certificates and keys (secure in /data)
ca ${pki_dir}/ca.crt
cert ${pki_dir}/issued/server.crt
key ${pki_dir}/private/server.key
dh ${pki_dir}/dh.pem
tls-auth ${pki_dir}/ta.key 0

# Network configuration
server ${SERVER_SUBNET} ${SERVER_NETMASK}
ifconfig-pool-persist ${data_dir}/ipp.txt

# Push routes to clients
EOF

# Add DNS servers
for dns in $(bashio::config 'dns_servers'); do
    echo "push \"dhcp-option DNS ${dns}\"" >> "${server_conf}"
done

# Add routes
for route in $(bashio::config 'routes'); do
    echo "push \"route ${route}\"" >> "${server_conf}"
done

# Client options
if bashio::config.true 'client_to_client'; then
    echo "client-to-client" >> "${server_conf}"
fi

if bashio::config.true 'duplicate_cn'; then
    echo "duplicate-cn" >> "${server_conf}"
fi

# Continue server.conf
cat >> "${server_conf}" <<EOF

# Connection settings
max-clients ${MAX_CLIENTS}
keepalive 10 120
persist-key
persist-tun

# Security
cipher ${CIPHER}
auth ${AUTH}
tls-version-min 1.2

# Logging
status ${data_dir}/openvpn-status.log
verb ${LOG_LEVEL}

# Client config directory
client-config-dir ${data_dir}/ccd

# Explicit exit notify for UDP
explicit-exit-notify 1
EOF

# Create client config directory
mkdir -p "${data_dir}/ccd"

# Create user README in /share
cat > "${share_dir}/README.txt" <<'READMEEOF'
OpenVPN Server - Download Your Clients Here
============================================

1. Client configuration files (.ovpn) are in the "clients" folder
2. Download via File Editor or Samba share
3. Before using, edit the .ovpn file:
   - Change "YOUR_PUBLIC_IP_OR_DDNS" to your actual address
   
To create new clients:
- Open OpenVPN Server add-on
- Click "Terminal" tab (once add-on is running)
- Run: openvpn-client-add clientname

Access methods:
- File Editor: Browse to /share/openvpn/clients/
- Samba: \\homeassistant\share\openvpn\clients\
- SSH: /usr/share/hassio/share/openvpn/clients/
READMEEOF

# Enable IP forwarding
bashio::log.info "Enabling IP forwarding..."
sysctl -w net.ipv4.ip_forward=1 >/dev/null 2>&1 || \
    bashio::log.warning "Could not enable IP forwarding (may already be enabled)"

# Setup iptables rules
bashio::log.info "Configuring firewall rules..."
iptables -t nat -A POSTROUTING -s ${SERVER_SUBNET}/24 -o eth0 -j MASQUERADE 2>&1 || true
iptables -A FORWARD -i tun0 -j ACCEPT 2>&1 || true
iptables -A FORWARD -o tun0 -j ACCEPT 2>&1 || true

bashio::log.info "PKI secure in: /data/openvpn/pki/"
bashio::log.info "Download clients from: /share/openvpn/clients/"
bashio::log.info "Starting OpenVPN..."

# Start OpenVPN
openvpn --config "${server_conf}" 2>&1
