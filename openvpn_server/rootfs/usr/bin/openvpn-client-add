#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

# PKI in /data, output in /share
declare data_dir="/data/openvpn"
declare pki_dir="${data_dir}/pki"
declare easyrsa_dir="${data_dir}/easy-rsa"
declare clients_dir="/share/openvpn/clients"
declare client_name="${1}"

if [[ -z "${client_name}" ]]; then
    bashio::log.error "Usage: openvpn-client-add <client-name>"
    exit 1
fi

if [[ ! "${client_name}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    bashio::log.error "Invalid name. Use letters, numbers, hyphens, underscores only"
    exit 1
fi

cd "${easyrsa_dir}" || exit 1

if [[ -f "${pki_dir}/issued/${client_name}.crt" ]]; then
    bashio::log.error "Client '${client_name}' already exists"
    exit 1
fi

bashio::log.info "Generating certificate for: ${client_name}"

EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
EASYRSA_REQ_CN="${client_name}" \
./easyrsa build-client-full "${client_name}" nopass || exit 1

PROTO=$(bashio::config 'proto')
PORT=$(bashio::config 'port')
CIPHER=$(bashio::config 'cipher')
AUTH=$(bashio::config 'auth')

mkdir -p "${clients_dir}"

cat > "${clients_dir}/${client_name}.ovpn" <<EOF
# OpenVPN Client: ${client_name}
# Generated: $(date)

client
dev tun
proto ${PROTO}
remote YOUR_PUBLIC_IP_OR_DDNS ${PORT}
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher ${CIPHER}
auth ${AUTH}
verb 3
key-direction 1

<ca>
$(cat "${pki_dir}/ca.crt")
</ca>

<cert>
$(openssl x509 -in "${pki_dir}/issued/${client_name}.crt")
</cert>

<key>
$(cat "${pki_dir}/private/${client_name}.key")
</key>

<tls-auth>
$(cat "${pki_dir}/ta.key")
</tls-auth>
EOF

chmod 600 "${clients_dir}/${client_name}.ovpn"

bashio::log.info "✓ Client '${client_name}' created!"
bashio::log.info "✓ Download from: /share/openvpn/clients/${client_name}.ovpn"
bashio::log.notice "⚠ Edit file: Change YOUR_PUBLIC_IP_OR_DDNS before using!"

exit 0
