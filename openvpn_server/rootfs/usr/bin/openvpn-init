#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

# PKI stored securely in /data
declare data_dir="/data/openvpn"
declare pki_dir="${data_dir}/pki"
declare easyrsa_dir="${data_dir}/easy-rsa"

bashio::log.info "Initializing PKI (secure in /data)..."

mkdir -p "${data_dir}"
mkdir -p "${easyrsa_dir}"

cp -r /usr/share/easy-rsa/* "${easyrsa_dir}/"
cd "${easyrsa_dir}" || bashio::exit.nok "Cannot access EasyRSA"

bashio::log.info "Creating PKI structure..."
EASYRSA_PKI="${pki_dir}" ./easyrsa init-pki || exit 1

bashio::log.info "Generating CA..."
EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
EASYRSA_REQ_CN="HomeAssistant-OpenVPN-CA" \
./easyrsa build-ca nopass || exit 1

bashio::log.info "Generating server certificate..."
EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
EASYRSA_REQ_CN="server" \
./easyrsa build-server-full server nopass || exit 1

bashio::log.info "Generating DH parameters (1-2 minutes)..."
EASYRSA_PKI="${pki_dir}" ./easyrsa gen-dh || exit 1

bashio::log.info "Generating TLS auth key..."
openvpn --genkey secret "${pki_dir}/ta.key" || exit 1

bashio::log.info "Generating CRL..."
EASYRSA_PKI="${pki_dir}" ./easyrsa gen-crl || exit 1

chmod 600 "${pki_dir}/private/"* 2>/dev/null
chmod 644 "${pki_dir}/issued/"* 2>/dev/null
chmod 644 "${pki_dir}/ca.crt" 2>/dev/null
chmod 644 "${pki_dir}/dh.pem" 2>/dev/null
chmod 600 "${pki_dir}/ta.key" 2>/dev/null

bashio::log.info "âœ“ PKI initialized successfully"
exit 0
