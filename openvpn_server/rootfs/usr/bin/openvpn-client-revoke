#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Revoke an OpenVPN client certificate
# ==============================================================================

declare config_dir="/data/openvpn"
declare pki_dir="${config_dir}/pki"
declare easyrsa_dir="${config_dir}/easy-rsa"
declare client_name="${1}"

if [[ -z "${client_name}" ]]; then
    bashio::log.error "Usage: openvpn-client-revoke <client-name>"
    exit 1
fi

cd "${easyrsa_dir}" || bashio::exit.nok "Cannot access EasyRSA directory"

# Check if client exists
if [[ ! -f "${pki_dir}/issued/${client_name}.crt" ]]; then
    bashio::log.error "Client '${client_name}' does not exist!"
    exit 1
fi

bashio::log.warning "Revoking certificate for client: ${client_name}"

# Revoke certificate
EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
./easyrsa revoke "${client_name}"

# Regenerate CRL
bashio::log.info "Regenerating Certificate Revocation List..."
EASYRSA_PKI="${pki_dir}" ./easyrsa gen-crl

# Update server config to use CRL
declare server_conf="${config_dir}/server.conf"
if ! grep -q "crl-verify" "${server_conf}"; then
    echo "crl-verify ${pki_dir}/crl.pem" >> "${server_conf}"
fi

bashio::log.info "✓ Client '${client_name}' certificate revoked!"
bashio::log.info "✓ Restart the add-on for changes to take effect"

# Remove client config file
if [[ -f "/share/${client_name}.ovpn" ]]; then
    rm "/share/${client_name}.ovpn"
    bashio::log.info "✓ Client configuration file removed from /share/"
fi

exit 0
