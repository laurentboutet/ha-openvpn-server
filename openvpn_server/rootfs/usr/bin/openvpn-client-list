#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# List all OpenVPN clients
# ==============================================================================

declare data_dir="/data/openvpn"
declare pki_dir="${data_dir}/pki"
declare index_file="${pki_dir}/index.txt"

if [[ ! -f "${index_file}" ]]; then
    bashio::log.error "No clients found. PKI not initialized."
    exit 1
fi

bashio::log.info "OpenVPN Clients:"
bashio::log.info "================================================"

# Parse index.txt for valid (V) and revoked (R) certificates
while IFS= read -r line; do
    status=$(echo "${line}" | awk '{print $1}')
    cn=$(echo "${line}" | awk -F'/CN=' '{print $2}' | cut -d'/' -f1)
    
    # Skip server and CA entries
    if [[ "${cn}" == "server" ]] || [[ "${cn}" == *"CA"* ]]; then
        continue
    fi
    
    if [[ "${status}" == "V" ]]; then
        echo "  ✓ ${cn} (Active)"
    elif [[ "${status}" == "R" ]]; then
        echo "  ✗ ${cn} (Revoked)"
    fi
done < "${index_file}"

bashio::log.info "================================================"

# Show connected clients if status log exists
if [[ -f "${data_dir}/openvpn-status.log" ]]; then
    bashio::log.info "Currently Connected:"
    bashio::log.info "================================================"
    
    awk '/CLIENT_LIST/ {print "  → " $2 " (" $3 ") - Connected: " $8 " " $9}' \
        "${data_dir}/openvpn-status.log" 2>/dev/null || echo "  No clients connected"
    
    bashio::log.info "================================================"
fi

exit 0
