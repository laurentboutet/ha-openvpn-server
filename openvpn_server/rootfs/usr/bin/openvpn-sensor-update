#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

declare status_file="/data/openvpn/openvpn-status.log"
declare ha_api="http://supervisor/core/api/states/sensor.openvpn_connected_clients"

while true; do
    sleep 30
    
    count=0
    clients=""
    
    if [[ -f "${status_file}" ]]; then
        count=$(grep -c "^CLIENT_LIST" "${status_file}" 2>/dev/null || echo "0")
        clients=$(awk '/^CLIENT_LIST/ {print $2}' "${status_file}" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
    fi
    
    if bashio::supervisor.ping; then
        curl -sSL -X POST \
            -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"state\":\"${count}\",\"attributes\":{\"friendly_name\":\"OpenVPN Connected Clients\",\"icon\":\"mdi:account-network\",\"clients\":\"${clients}\",\"unit_of_measurement\":\"clients\"}}" \
            "${ha_api}" >/dev/null 2>&1 || true
    fi
done
