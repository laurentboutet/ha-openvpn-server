#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Monitoring script - updates HA sensors
# ==============================================================================

declare data_dir="/data/openvpn"
declare status_file="${data_dir}/openvpn-status.log"
declare ha_token
declare ha_url="http://supervisor/core/api"

# Get HA API token
ha_token=$(bashio::var.json hassio_token)

# Check if sensors are enabled
if ! bashio::config.true 'enable_sensors'; then
    exit 0
fi

# Count connected clients
declare connected_count=0
if [[ -f "${status_file}" ]]; then
    connected_count=$(grep -c "^CLIENT_LIST" "${status_file}" 2>/dev/null || echo "0")
fi

# Get list of connected clients
declare connected_clients=""
if [[ -f "${status_file}" ]]; then
    connected_clients=$(awk '/^CLIENT_LIST/ {print $2}' "${status_file}" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
fi

# Get server uptime from status file
declare server_since=""
if [[ -f "${status_file}" ]]; then
    server_since=$(awk '/^Updated/ {print $2, $3, $4, $5, $6}' "${status_file}" 2>/dev/null | head -1)
fi

# Update HA sensor via API
curl -X POST \
    -H "Authorization: Bearer ${ha_token}" \
    -H "Content-Type: application/json" \
    -d "{
        \"state\": \"${connected_count}\",
        \"attributes\": {
            \"friendly_name\": \"OpenVPN Connected Clients\",
            \"icon\": \"mdi:vpn\",
            \"clients\": \"${connected_clients}\",
            \"server_since\": \"${server_since}\",
            \"unit_of_measurement\": \"clients\"
        }
    }" \
    "${ha_url}/states/sensor.openvpn_connected_clients" \
    >/dev/null 2>&1

exit 0
