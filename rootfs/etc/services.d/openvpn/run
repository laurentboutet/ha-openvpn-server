#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Runs the OpenVPN server
# ==============================================================================
declare -a options
declare config_dir="/data/openvpn"
declare pki_dir="${config_dir}/pki"
declare server_conf="${config_dir}/server.conf"

bashio::log.info "Starting OpenVPN Server..."

# Check if PKI is initialized
if [[ ! -f "${pki_dir}/ca.crt" ]]; then
    bashio::log.info "PKI not initialized. Running initialization..."
    /usr/bin/openvpn-init || bashio::exit.nok "Failed to initialize PKI"
fi

# Get configuration
PROTO=$(bashio::config 'proto')
PORT=$(bashio::config 'port')
SERVER_SUBNET=$(bashio::config 'server_subnet')
SERVER_NETMASK=$(bashio::config 'server_netmask')
CIPHER=$(bashio::config 'cipher')
AUTH=$(bashio::config 'auth')
CLIENT_TO_CLIENT=$(bashio::config 'client_to_client')
DUPLICATE_CN=$(bashio::config 'duplicate_cn')
MAX_CLIENTS=$(bashio::config 'max_clients')
LOG_LEVEL=$(bashio::config 'log_level')

bashio::log.info "Generating server configuration..."

# Create server.conf
cat > "${server_conf}" <<EOF
# OpenVPN Server Configuration
# Generated by Home Assistant Add-on
port ${PORT}
proto ${PROTO}
dev tun0
topology subnet

# Certificates and keys
ca ${pki_dir}/ca.crt
cert ${pki_dir}/issued/server.crt
key ${pki_dir}/private/server.key
dh ${pki_dir}/dh.pem
tls-auth ${pki_dir}/ta.key 0

# Network configuration
server ${SERVER_SUBNET} ${SERVER_NETMASK}
ifconfig-pool-persist ${config_dir}/ipp.txt

# Push routes to clients
EOF

# Add DNS servers
for dns in $(bashio::config 'dns_servers'); do
    echo "push \"dhcp-option DNS ${dns}\"" >> "${server_conf}"
done

# Add routes
for route in $(bashio::config 'routes'); do
    echo "push \"route ${route}\"" >> "${server_conf}"
done

# Client options
if bashio::config.true 'client_to_client'; then
    echo "client-to-client" >> "${server_conf}"
fi

if bashio::config.true 'duplicate_cn'; then
    echo "duplicate-cn" >> "${server_conf}"
fi

# Continue server.conf
cat >> "${server_conf}" <<EOF

# Connection settings
max-clients ${MAX_CLIENTS}
keepalive 10 120
persist-key
persist-tun

# Security
cipher ${CIPHER}
auth ${AUTH}
tls-version-min 1.2
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384:TLS-ECDHE-RSA-WITH-AES-128-GCM-SHA256

# Logging
status ${config_dir}/openvpn-status.log
log-append ${config_dir}/openvpn.log
verb ${LOG_LEVEL}
mute 20

# Performance
sndbuf 393216
rcvbuf 393216
push "sndbuf 393216"
push "rcvbuf 393216"
txqueuelen 1000

# Client config directory
client-config-dir ${config_dir}/ccd

# Explicit exit notify for UDP
explicit-exit-notify 1
EOF

# Create client config directory
mkdir -p "${config_dir}/ccd"

# Enable IP forwarding
bashio::log.info "Enabling IP forwarding..."
echo 1 > /proc/sys/net/ipv4/ip_forward

# Setup iptables rules
bashio::log.info "Configuring firewall rules..."
iptables -t nat -A POSTROUTING -s ${SERVER_SUBNET}/24 -o eth0 -j MASQUERADE
iptables -A FORWARD -i tun0 -j ACCEPT
iptables -A FORWARD -o tun0 -j ACCEPT

bashio::log.info "OpenVPN Server configuration complete!"
bashio::log.info "Server listening on ${PROTO}/${PORT}"
bashio::log.info "VPN subnet: ${SERVER_SUBNET}/${SERVER_NETMASK}"

# Start OpenVPN
exec openvpn --config "${server_conf}"
