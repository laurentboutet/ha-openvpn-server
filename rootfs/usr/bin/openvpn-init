#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Initialize PKI infrastructure
# ==============================================================================

declare config_dir="/data/openvpn"
declare pki_dir="${config_dir}/pki"
declare easyrsa_dir="${config_dir}/easy-rsa"

bashio::log.info "Initializing OpenVPN PKI..."

# Create directories
mkdir -p "${config_dir}"
mkdir -p "${easyrsa_dir}"

# Copy EasyRSA
cp -r /usr/share/easy-rsa/* "${easyrsa_dir}/"
cd "${easyrsa_dir}" || bashio::exit.nok "Cannot access EasyRSA directory"

# Initialize PKI
bashio::log.info "Creating PKI structure..."
EASYRSA_PKI="${pki_dir}" ./easyrsa init-pki

# Create CA
bashio::log.info "Generating Certificate Authority..."
EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
EASYRSA_REQ_CN="HomeAssistant-OpenVPN-CA" \
./easyrsa build-ca nopass

# Generate server certificate
bashio::log.info "Generating server certificate..."
EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
EASYRSA_REQ_CN="server" \
./easyrsa build-server-full server nopass

# Generate DH parameters
bashio::log.info "Generating Diffie-Hellman parameters (this may take a while)..."
EASYRSA_PKI="${pki_dir}" ./easyrsa gen-dh

# Generate TLS-auth key
bashio::log.info "Generating TLS authentication key..."
openvpn --genkey secret "${pki_dir}/ta.key"

# Generate CRL
bashio::log.info "Generating Certificate Revocation List..."
EASYRSA_PKI="${pki_dir}" ./easyrsa gen-crl

# Set permissions
chmod 600 "${pki_dir}/private/"*
chmod 644 "${pki_dir}/issued/"*
chmod 644 "${pki_dir}/ca.crt"
chmod 644 "${pki_dir}/dh.pem"
chmod 600 "${pki_dir}/ta.key"

bashio::log.info "PKI initialization complete!"
bashio::log.info "CA certificate: ${pki_dir}/ca.crt"
bashio::log.info "Server certificate: ${pki_dir}/issued/server.crt"
bashio::log.info "Server key: ${pki_dir}/private/server.key"

exit 0
