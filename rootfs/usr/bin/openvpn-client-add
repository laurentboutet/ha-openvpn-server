#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: OpenVPN Server
# Add a new OpenVPN client
# ==============================================================================

declare config_dir="/data/openvpn"
declare pki_dir="${config_dir}/pki"
declare easyrsa_dir="${config_dir}/easy-rsa"
declare client_name="${1}"

if [[ -z "${client_name}" ]]; then
    bashio::log.error "Usage: openvpn-client-add <client-name>"
    exit 1
fi

# Validate client name
if [[ ! "${client_name}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    bashio::log.error "Client name can only contain letters, numbers, hyphens, and underscores"
    exit 1
fi

cd "${easyrsa_dir}" || bashio::exit.nok "Cannot access EasyRSA directory"

# Check if client already exists
if [[ -f "${pki_dir}/issued/${client_name}.crt" ]]; then
    bashio::log.error "Client '${client_name}' already exists!"
    exit 1
fi

bashio::log.info "Generating certificate for client: ${client_name}"

# Generate client certificate
EASYRSA_PKI="${pki_dir}" \
EASYRSA_BATCH=1 \
EASYRSA_REQ_CN="${client_name}" \
./easyrsa build-client-full "${client_name}" nopass

# Get configuration
PROTO=$(bashio::config 'proto')
PORT=$(bashio::config 'port')
CIPHER=$(bashio::config 'cipher')
AUTH=$(bashio::config 'auth')

# Get HA instance URL/IP
if bashio::supervisor.ping; then
    HA_URL=$(bashio::info.hostname)
else
    HA_URL="YOUR_HOME_ASSISTANT_IP"
fi

bashio::log.info "Generating client configuration file..."

# Create client .ovpn file
cat > "/share/${client_name}.ovpn" <<EOF
# OpenVPN Client Configuration
# Client: ${client_name}
# Generated: $(date)

client
dev tun
proto ${PROTO}
remote ${HA_URL} ${PORT}
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher ${CIPHER}
auth ${AUTH}
verb 3
key-direction 1

# Inline certificates and keys
<ca>
$(cat "${pki_dir}/ca.crt")
</ca>

<cert>
$(openssl x509 -in "${pki_dir}/issued/${client_name}.crt")
</cert>

<key>
$(cat "${pki_dir}/private/${client_name}.key")
</key>

<tls-auth>
$(cat "${pki_dir}/ta.key")
</tls-auth>
EOF

chmod 600 "/share/${client_name}.ovpn"

bashio::log.info "✓ Client '${client_name}' created successfully!"
bashio::log.info "✓ Configuration file: /share/${client_name}.ovpn"
bashio::log.info "✓ Download from Home Assistant: Settings -> Add-ons -> OpenVPN -> File Editor or Samba"
bashio::log.notice "Remember to update 'remote ${HA_URL}' with your public IP/DDNS in the .ovpn file!"

exit 0
